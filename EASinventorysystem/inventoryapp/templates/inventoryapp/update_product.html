<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
<link rel="stylesheet" href="static/add_product.css">
{% extends 'inventoryapp/base.html' %}
{% load static %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
<link rel="stylesheet" href="static/add_product.css">

{% block content %}
<div class="container-fluid">
    <div class="row p-1" style="background-color: #eee;">
        <div class="col-md-auto d-flex align-items-center">
            <h4 class="m-0 mr-3">Edit Product Details</h4>
        </div>
    </div>
    <form method="POST" action="{% url 'update_product' pk=p.Product_ID %}" enctype="multipart/form-data">
        {% csrf_token %}
        <legend>Product Information</legend>
        <div class="form-group mb-3">
            <div class="form-check form-switch">
                <input type="hidden" name="product_visibility" value="False" />
                <input class="form-check-input" type="checkbox" name="product_visibility" value="True" id="id_Visibility" {% if p.Visibility %}checked{% endif %}>
                <label class="form-check-label" for="id_Visibility">Visibility</label>
            </div>
        </div>
        <!-- <div class="mb-3">
            <div class="border p-3">
                <div class="form-group mb-0">
                    <div class="form-check">
                        <input type="hidden" name="product_visibility" value="False" />
                        <input class="form-check-input" type="checkbox" name="product_visibility" value="True" id="id_Visibility" {% if p.Visibility %}checked{% endif %}>
                        <label class="form-check-label" for="id_Visibility">Visibility</label>
                    </div>
                </div>
            </div>
        </div> -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="id_EAS_Product_ID" class="form-label custom-text">EAS Product ID:</label>
                <input type="text" name="eas_id" class="form-control" maxlength="32" id="id_EAS_Product_ID" value="{{ p.EAS_Product_ID }}">
            </div>
            <div class="col-md-4">
                <label for="id_Name" class="form-label custom-text">Name:</label>
                <input type="text" name="product_name" class="form-control" maxlength="64" id="id_Name" value="{{ p.Name }}">
            </div>
            <div class="col-md-4">
                <label for="id_SKU" class="form-label custom-text">SKU:</label>
                <input type="text" name="product_sku" class="form-control" maxlength="64" id="id_SKU" value="{{ p.SKU }}">
            </div>
        </div>

        

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="id_Price" class="form-label custom-text">Price:</label>
                <input type="number" name="product_price" step="0.01" min="0" id="id_Price" class="form-control" value="{{ p.Price }}">
            </div>
            <div class="col-md-6">
                {% if p.Product_Low_Stock_Threshold %}
                    <label for="id_Stock_Level_Threshold" class="form-label custom-text">Stock Level Threshold:</label>
                    <input type="number" name="product_stock_level_threshold" class="form-control" id="id_Stock_Level_Threshold" value="{{ p.Product_Low_Stock_Threshold }}">
                {% else %}
                <label for="id_Stock_Level_Threshold" class="form-label custom-text">Stock Level Threshold:</label>
                <input type="number" name="product_stock_level_threshold" class="form-control" id="id_Stock_Level_Threshold" value="0">
                {% endif %}
            </div>
        </div>

        <!-- <div class="form-group mb-3">
            <div class="checkbox">
                <input type="hidden" name="product_visibility" value="False" />
                <label><input type="checkbox" name="product_visibility" value="True" id="id_Visibility" {% if p.Visibility %}checked{% endif %}>Visibility</label>
            </div>
        </div> -->
        <div class="mb-3">
            <div class="row">
                <div class="col-md-4">
                    <label for="id_Category" class="form-label custom-text">Category:</label>
            <select name="product_category" class="form-select" id="id_Category" required>
                <option value="{{ p.Category.Category_ID }}">{{ p.Category }}</option>
                {% for cat in categories %}
                    {% if cat.Category_ID != p.Category.Category_ID %}
                        <option value="{{ cat.Category_ID }}">{{ cat.Category_Name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
                    <div class="col-md-3"></div> <!-- Invisible column -->
                    <div class="col-md-3"></div> <!-- Invisible column -->
                </div>
            </div>
<!-- 
            <div class="mb-3">
                <label for="id_Consignees" class="form-label custom-text">Consignee:</label>
                <div class="border p-3" style="max-height: 200px; overflow-y: auto;">
                    {% for cp in con_p %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="product_consignees" value="{{ cp.Consignee_ID.Consignee_ID }}" id="consignee_{{ cp.Consignee_ID.Consignee_ID }}" checked>
                        <label class="form-check-label" for="consignee_{{ cp.Consignee_ID.Consignee_ID }}">
                            {{ cp.Consignee_ID }}
                        </label>
                    </div>
                    {% endfor %}
                    {% for con in consignees %}
                        {% if con.Consignee_ID not in con_p_ids %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="product_consignees" value="{{ con.Consignee_ID }}" id="consignee_{{ con.Consignee_ID }}">
                            <label class="form-check-label" for="consignee_{{ con.Consignee_ID }}">
                                {{ con.Consignee_Name }}
                            </label>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
             -->
        <div class="mb-3">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label custom-text">Consignee:   </label>
                    <input type="text" id="consignee-search" class="form-control mb-2" placeholder="Search consignee..." style="margin-bottom: 10px;">
                    <div id="consignee-list" style="height: 100px; overflow-y: auto;"> <!-- Adjust height as needed -->
                        {% for con in consignees %}
                        <div class="consignee-item">
                            <input class="form-check-input" type="checkbox" name="product_consignees" value="{{ con.Consignee_ID }}" id="consignee_{{ con.Consignee_ID }}">
                            <label class="form-check-label" for="consignee_{{ con.Consignee_ID }}">{{ con.Consignee_Name }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-md-6">
                    <!-- Box for chosen pills/consignees -->
                    <div id="chosen-consignees" class="border p-3" style="max-height: 200px; overflow-y: auto;">
                        Chosen Consignees:
                        {% for cp in con_p %}
                        <div class="form-check pill-shape">
                            <input class="form-check-input" type="checkbox" name="product_consignees" value="{{ cp.Consignee_ID.Consignee_ID }}" id="consignee_{{ cp.Consignee_ID.Consignee_ID }}" checked>
                            <label class="form-check-label" for="consignee_{{ cp.Consignee_ID.Consignee_ID }}">
                                {{ cp.Consignee_ID }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <style>
            .pill-shape {
                display: inline-block;
                padding: .25em .6em;
                font-size: 75%;
                font-weight: 700;
                line-height: 1.3;
                text-align: center;
                white-space: nowrap;
                vertical-align: baseline;
                border-radius: 10rem;
                background-color: #007bff;
                color: #fff;
                margin-bottom: 10px;
                margin-right: 5px;
                margin-left: 10px; /* Adjust the margin as needed */
            }
        </style>
        
        <script>
            // JavaScript for search functionality
            document.getElementById('consignee-search').addEventListener('input', function() {
                const searchText = this.value.toLowerCase();
                const consignees = document.querySelectorAll('#consignee-list .consignee-item');
        
                consignees.forEach(function(consignee) {
                    const name = consignee.querySelector('.form-check-label').textContent.toLowerCase();
                    if (name.includes(searchText)) {
                        consignee.style.display = 'inline-block'; // Change display to inline-block
                    } else {
                        consignee.style.display = 'none';
                    }
                });
            });
        
            // JavaScript for toggling pill shape class and moving checked pills to the chosen box
            document.querySelectorAll('#consignee-list input[type="checkbox"]').forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    const label = this.parentNode.querySelector('.form-check-label');
                    const container = this.parentNode.parentNode;
        
                    if (this.checked) {
                        const length = label.textContent.trim().length;
                        label.style.width = (length * 10) + 'px'; // Adjust the multiplier for desired width
        
                        // Check if the consignee is already in the chosen consignees list
                        const existingPill = document.querySelector('#chosen-consignees input[type="checkbox"][value="' + this.value + '"]');
                        if (!existingPill) {
                            this.parentNode.classList.add('pill-shape');
                            const clonedNode = this.parentNode.cloneNode(true);
                            clonedNode.querySelector('input[type="checkbox"]').checked = true; // Ensure checkbox is checked
                            document.getElementById('chosen-consignees').appendChild(clonedNode); // Move checked pill to the chosen box
                        } else {
                            // If the consignee is already chosen, prevent duplication
                            this.checked = false;
                        }
        
                        // Hide the selected consignee in the list
                        this.parentNode.style.display = 'none';
                    } else {
                        label.style.width = ''; // Reset width
                        this.parentNode.classList.remove('pill-shape');
                        const originalCheckbox = document.querySelector('#chosen-consignees input[type="checkbox"][value="' + this.value + '"]');
                        if (originalCheckbox) {
                            originalCheckbox.parentNode.remove(); // Remove the unchecked pill from the chosen box
                        }
                        this.parentNode.style.display = 'inline-block'; // Show the consignee back in the list
                    }
                });
            });
        
            // JavaScript for handling unchecked pills in the chosen box
            document.querySelectorAll('#chosen-consignees input[type="checkbox"]').forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                    if (!this.checked) {
                        this.parentNode.remove(); // Remove the unchecked pill from the chosen box
                        const originalCheckbox = document.querySelector('#consignee-list input[type="checkbox"][value="' + this.value + '"]');
                        originalCheckbox.checked = false; // Uncheck the original checkbox in the list
                        originalCheckbox.parentNode.style.display = 'inline-block'; // Show the consignee back in the list
                    }
                });
            });
        </script>
<!--         
        <div class="mb-3">
            <label for="id_Picture" class="form-label custom-text">Picture:</label>
            <div id="image-preview">
                {% if p.Picture %}
                <div class="product-image"> 
                    <img src="{{ p.Picture.url }}" width="50">
                </div>
                {% endif %}
            </div>
            <div style="display: flex; align-items: center;">
                <input type="file" name="product_picture" accept="image/*" id="id_Picture" class="form-control" style="flex: 1; margin-right: 8px;">
                <button type="button" id="remove-image" {% if not p.Picture %}style="display: none;"{% endif %} class="btn btn-outline-danger">Remove Image</button>
            </div>
            <input type="hidden" name="removed_product_picture" id="remove-product-picture" value='Not'>
        </div>
         -->
        <div class="mb-3">
            <div class="row">
                <div class="col-md-5">
                    <label for="id_Picture" class="form-label custom-text">Picture:</label>
            <div id="image-preview">
                {% if p.Picture %}
                <div class="product-image"> 
                    <img src="{{ p.Picture.url }}" width="50">
                </div>
                {% endif %}
            </div>
            <div style="display: flex; align-items: center;">
                <input type="file" name="product_picture" accept="image/*" id="id_Picture" class="form-control" style="flex: 1; margin-right: 8px;"> <!-- Added margin-right -->
                <button type="button" id="remove-image" {% if not p.Picture %}style="display: none;"{% endif %} class="btn btn-outline-danger">Remove Image</button>
            </div>
            <input type="hidden" name="removed_product_picture" id="remove-product-picture" value='Not'>
                    <div class="col-md-3"></div> <!-- Invisible column -->
                    <div class="col-md-3"></div> <!-- Invisible column -->
                </div>
            </div>
        


        <script>
            document.addEventListener("DOMContentLoaded", function() {
            const pictureInput = document.getElementById("id_Picture");
            const imagePreview = document.getElementById("image-preview");
            const removeImageButton = document.getElementById("remove-image");
            const imageRemoved = document.getElementById("remove-product-picture");

            // Function to update the image preview
            function updatePreview() {
                const file = pictureInput.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const image = new Image();
                        image.src = event.target.result;
                        image.width = 50;
                        imagePreview.innerHTML = '';
                        imagePreview.appendChild(image);
                        imageRemoved.value = "Not";
                        removeImageButton.style.display = "inline-block"; // Show the "Remove Image" button
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.innerHTML = '';
                }
            }

            // Event listener for input change
            pictureInput.addEventListener("change", updatePreview);

            // Event listener for remove image button
            removeImageButton.addEventListener("click", function() {
                pictureInput.value = null; // Clear the input field
                removeImageButton.style.display = "none"; // Hide the "Remove Image" button
                imageRemoved.value = "removed";
                updatePreview(); // Update the preview to remove the image
            });
        });

        </script>
        
        <div class="row">
            <div class="col-md-6" style="margin-top: 10px;">
                <a href="{% url 'current_inventory' %}" class="btn btn-secondary">Cancel</a>
            </div>
            <div class="col-md-6 text-end">
                <button type="submit" class="btn btn-success" name="Add" onclick="return confirm('Are you sure you want to update this product?')">Update</button>
            </div>
        </div>

        <!-- <div class="row">
            <button type="submit" class="btn btn-success" name="Add">Update</button>
            <a href="{% url 'current_inventory' %}" class="btn btn-danger">Cancel</a>
        </div>   -->
    </form>
</div>
{% endblock %}
